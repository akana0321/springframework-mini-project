<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
                 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- dao의 interface와 연결하기 위해 namespace에 해당 인터페이스 경로를 줌 -->
<mapper namespace="com.mycompany.webapp.dao.HospitalDao">
	<resultMap id="selectByHnumberResultMap" type="hospital">
		<result column="hospital_number" property="hnumber"/>
		<result column="user_id" property="uid"/>
		<result column="hospital_name" property="hname"/>
		<result column="hospital_tel" property="htel"/>
		<result column="hospital_zipcode" property="hzipcode"/>
		<result column="hostpital_address1" property="haddress1"/>
		<result column="hospital_address2" property="haddress2"/>
		<result column="hospital_employees" property="hemployees"/>
		<result column="hospital_py" property="hpy"/>
		
		<association property="hattaches" javaType="attach">
			<result column="attach_no" property="ano"/>
			<result column="attach_target_table" property="attable"/>
			<result column="attach_target_id" property="atid"/>
			<result column="attach_target_index" property="atindex"/>
			<result column="attach_content_type" property="acontentType"/>
			<result column="attach_save_name" property="asname"/>
			<result column="attach_original_name" property="aoname"/>
		</association>
	</resultMap>
	
	<select id="selectByHnumber" parameterType="int" resultMap="selectByHnumberResultMap">
		SELECT hospital_number, user_id, hospital_name, hospital_tel, hospital_zipcode, hostpital_address1, hospital_address2, hospital_employees, hospital_py,
			   attach_no, attach_target_table, attach_target_id, attach_target_index, attach_content_type, attach_save_name, attach_original_name
	   	FROM hospital h, attach a
	   	WHERE a.attach_target_table like 'HOSPITAL'
	   	 AND h.hospital_number = a.attach_target_id
	   	 AND h.hospital_number = #{hnumber}
	</select>
	
	<resultMap id="selectByUidResultMap" type="hospital">
		<result column="hospital_number" property="hnumber"/>
		<result column="user_id" property="uid"/>
		<result column="hospital_name" property="hname"/>
		<result column="hospital_tel" property="htel"/>
		<result column="hospital_zipcode" property="hzipcode"/>
		<result column="hostpital_address1" property="haddress1"/>
		<result column="hospital_address2" property="haddress2"/>
		<result column="hospital_employees" property="hemployees"/>
		<result column="hospital_py" property="hpy"/>
		
		<association property="hattaches" javaType="attach">
			<result column="attach_no" property="ano"/>
			<result column="attach_target_table" property="attable"/>
			<result column="attach_target_id" property="atid"/>
			<result column="attach_target_index" property="atindex"/>
			<result column="attach_content_type" property="acontentType"/>
			<result column="attach_save_name" property="asname"/>
			<result column="attach_original_name" property="aoname"/>
		</association>
	</resultMap>
	
	<select id="selectByUid" parameterType="string" resultMap="selectByUidResultMap">
		SELECT hospital_number, user_id, hospital_name, hospital_tel, hospital_zipcode, hostpital_address1, hospital_address2, hospital_employees, hospital_py,
			   attach_no, attach_target_table, attach_target_id, attach_target_index, attach_content_type, attach_save_name, attach_original_name
	   	FROM hospital h, attach a
	   	WHERE a.attach_target_table like 'HOSPITAL'
	   	 AND h.hospital_number = a.attach_target_id
	   	 AND h.user_id = #{uid}
	</select>
	
	<select id="count" resultType="int">
		SELECT count(*) FROM hospital
	</select>

	<insert id="insert" parameterType="hospital">
		INSERT ALL
			INTO hospital (hospital_number, user_id, hospital_name, hospital_tel, hospital_zipcode, hostpital_address1, hospital_address2, hospital_employees, hospital_py) 
			VALUES(#{hnumber}, #{uid}, #{hname}, #{htel}, #{hzipcode}, #{haddress1}, #{haddress2}, #{hemployees}, #{hpy})
			<if test="hattaches != null">
				<foreach collection="hattaches" item="hattach" separator=" " close="SELECT * FROM DUAL">
					INTO attach (attach_no, attach_target_table, attach_target_id, attach_target_index, attach_content_type, attach_save_name, attach_original_name)
					value VALUES(SEQ_ATTACH_ANO, #{hattach.attable}, #{hattach.atid}, #{hattach.atindex}, #{hattach.acontentType}, #{hattach.asname}, #{hattach.aoname})
				</foreach>
			</if>
	</insert>
	
	<delete id="deleteByHnumber" parameterType="int">
		DELETE FROM hospital WHERE hospital_number = #{hnumber};
		DELETE FROM attach
		WHERE attach_target_table like 'HOSPITAL'
		  AND attach_target_id=#{hnumber};
	</delete>
	
	<update id="update" parameterType="hospital">
		UPDATE hospital SET
				hospital_name = #{hname},
				hospital_tel = #{htel},
				hospital_zipcode = #{hzipcode},
				hostpital_address1 = #{haddress1},
				hospital_address2 = #{haddress2},
				hospital_employees = #{employees},
				hospital_py = #{hpy},
		WHERE hospital_number = #{hnumber}
		<foreach collection="hattaches" item="hattach" separator=";">
			UPDATE attach SET
				attach_content_type=#{hattach.acontentType},
				attach_save_name=#{hattach.asname},
				attach_original_name=#{hattach.aoname}
			WHERE attach_no = #{hattach.ano}
		</foreach>	
	</update>
</mapper>

